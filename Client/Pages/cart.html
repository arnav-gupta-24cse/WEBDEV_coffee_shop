<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brew Haven - Cart</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <!-- Navbar Component -->
    <div id="navbar"></div>

    <main>
        <section class="cart-container">
            <h2>Your Cart</h2>
            
            <div id="cart-items-container" class="cart-items">
                <!-- Cart items will be dynamically inserted here -->
            </div>

            <div class="cart-summary">
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="cart-subtotal">$0.00</span>
                </div>
                <div class="summary-row">
                    <span>Tax (5%):</span>
                    <span id="cart-tax">$0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span id="cart-total">$0.00</span>
                </div>
                <button class="btn btn-primary" onclick="proceedToCheckout()">Proceed to Checkout</button>
                <button class="btn btn-outline" onclick="clearCart()">Clear Cart</button>
            </div>
        </section>
    </main>

    <!-- Footer Component -->
    <div id="footer"></div>

    <!-- Scroll to Top Component -->
    <button class="scroll-to-top-btn" id="scrollToTopBtn" aria-label="Scroll to top">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 15l-6-6-6 6"/>
        </svg>
    </button>

    <script src="../script.js"></script>
    <script>
        const API_URL = 'http://localhost:5001/api/cart';
        const USER_ID = 'guest-user';

        // Update cart badge in navbar
        function updateCartBadge() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const cartCount = cart.reduce((total, item) => total + (item.quantity || 1), 0);
            const badge = document.getElementById('cartBadge');
            if (badge) {
                if (cartCount > 0) {
                    badge.textContent = cartCount;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
            // Also dispatch event for other pages
            window.dispatchEvent(new Event('cartUpdated'));
        }

        // Sync localStorage cart with MongoDB on page load
        async function syncCartWithBackend() {
            try {
                const localCart = JSON.parse(localStorage.getItem('cart') || '[]');
                
                if (localCart.length > 0) {
                    // Sync local cart to backend
                    const response = await fetch(`${API_URL}/${USER_ID}/sync`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ items: localCart })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Cart synced with backend:', data);
                    }
                }
                
                // Load cart from backend
                await loadCartFromBackend();
            } catch (error) {
                console.error('Error syncing cart:', error);
                // Fallback to localStorage if backend is unavailable
                renderCart();
            }
        }

        // Load cart from MongoDB
        async function loadCartFromBackend() {
            try {
                const response = await fetch(`${API_URL}/${USER_ID}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load cart');
                }
                
                const cartData = await response.json();
                renderCartFromBackend(cartData);
            } catch (error) {
                console.error('Error loading cart:', error);
                renderCart(); // Fallback to localStorage
            }
        }

        // Render cart from backend data
        function renderCartFromBackend(cartData) {
            const container = document.getElementById('cart-items-container');
            const subtotalEl = document.getElementById('cart-subtotal');
            const taxEl = document.getElementById('cart-tax');
            const totalEl = document.getElementById('cart-total');

            if (!cartData.items || cartData.items.length === 0) {
                container.innerHTML = '<p class="empty-cart">Your cart is empty. <a href="menu.html">Browse our menu</a> to add items!</p>';
                subtotalEl.textContent = '$0.00';
                taxEl.textContent = '$0.00';
                totalEl.textContent = '$0.00';
                return;
            }

            container.innerHTML = '';

            cartData.items.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                itemDiv.innerHTML = `
                    <div class="cart-item-info">
                        <h4>${item.name}</h4>
                        <p>$${item.price.toFixed(2)} each</p>
                    </div>
                    <div class="cart-item-quantity">
                        <button onclick="updateQuantityBackend(${index}, -1)">-</button>
                        <span>${item.quantity}</span>
                        <button onclick="updateQuantityBackend(${index}, 1)">+</button>
                    </div>
                    <div class="cart-item-total">
                        $${itemTotal.toFixed(2)}
                    </div>
                    <button class="cart-item-remove" onclick="removeItemBackend(${index})">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                `;
                container.appendChild(itemDiv);
            });

            subtotalEl.textContent = `$${cartData.subtotal.toFixed(2)}`;
            taxEl.textContent = `$${cartData.tax.toFixed(2)}`;
            totalEl.textContent = `$${cartData.total.toFixed(2)}`;
        }

        // Update quantity in MongoDB
        async function updateQuantityBackend(itemIndex, change) {
            try {
                const response = await fetch(`${API_URL}/${USER_ID}`);
                const cartData = await response.json();
                
                const newQuantity = cartData.items[itemIndex].quantity + change;
                
                if (newQuantity <= 0) {
                    // Remove item if quantity becomes 0
                    await removeItemBackend(itemIndex);
                    return;
                }
                
                const updateResponse = await fetch(`${API_URL}/${USER_ID}/items/${itemIndex}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ quantity: newQuantity })
                });
                
                if (updateResponse.ok) {
                    const updatedCart = await updateResponse.json();
                    renderCartFromBackend(updatedCart);
                    window.dispatchEvent(new Event('cartUpdated'));
                }
            } catch (error) {
                console.error('Error updating quantity:', error);
                alert('Failed to update quantity. Please try again.');
            }
        }

        // Remove item from MongoDB
        async function removeItemBackend(itemIndex) {
            try {
                if (!confirm('Remove this item from cart?')) return;
                
                const response = await fetch(`${API_URL}/${USER_ID}/items/${itemIndex}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const updatedCart = await response.json();
                    renderCartFromBackend(updatedCart);
                    window.dispatchEvent(new Event('cartUpdated'));
                }
            } catch (error) {
                console.error('Error removing item:', error);
                alert('Failed to remove item. Please try again.');
            }
        }

        // Clear entire cart from MongoDB
        async function clearCart() {
            if (!confirm('Are you sure you want to clear your cart?')) return;
            
            try {
                const response = await fetch(`${API_URL}/${USER_ID}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    renderCartFromBackend(result.cart);
                    localStorage.setItem('cart', '[]');
                    window.dispatchEvent(new Event('cartUpdated'));
                }
            } catch (error) {
                console.error('Error clearing cart:', error);
                alert('Failed to clear cart. Please try again.');
            }
        }

        async function proceedToCheckout() {
            try {
                // Get current cart
                const cartResponse = await fetch(`${API_URL}/${USER_ID}`);
                const cartData = await cartResponse.json();
                
                if (!cartData.items || cartData.items.length === 0) {
                    alert('Your cart is empty!');
                    return;
                }
                
                // Ask for confirmation
                const confirmed = confirm(
                    `Place Order?\n\n` +
                    `Items: ${cartData.totalItems}\n` +
                    `Subtotal: $${cartData.subtotal.toFixed(2)}\n` +
                    `Tax: $${cartData.tax.toFixed(2)}\n` +
                    `Total: $${cartData.total.toFixed(2)}`
                );
                
                if (!confirmed) {
                    return;
                }
                
                // Place order
                const orderResponse = await fetch(`http://localhost:5001/api/orders/${USER_ID}/place`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customerInfo: {
                            name: 'Guest User', // You can add a form to collect this
                        },
                        notes: ''
                    })
                });
                
                const result = await orderResponse.json();
                
                if (result.success) {
                    alert(
                        `âœ… Order Placed Successfully!\n\n` +
                        `Order Number: ${result.order.orderNumber}\n` +
                        `Total: $${result.order.total.toFixed(2)}\n` +
                        `Status: ${result.order.status}\n\n` +
                        `Your order has been saved to the database!`
                    );
                    
                    // Refresh cart display (cart is now empty after placing order)
                    await syncCartWithBackend();
                    
                    // Also clear localStorage
                    localStorage.setItem('cart', JSON.stringify([]));
                    updateCartBadge();
                } else {
                    alert('Failed to place order: ' + result.message);
                }
                
            } catch (error) {
                console.error('Error during checkout:', error);
                alert('Failed to place order. Please make sure the backend is running.');
            }
        }

        // Fallback to localStorage rendering (when backend is unavailable)
        function renderCart() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const container = document.getElementById('cart-items-container');
            const subtotalEl = document.getElementById('cart-subtotal');
            const taxEl = document.getElementById('cart-tax');
            const totalEl = document.getElementById('cart-total');

            if (cart.length === 0) {
                container.innerHTML = '<p class="empty-cart">Your cart is empty. <a href="menu.html">Browse our menu</a> to add items!</p>';
                subtotalEl.textContent = '$0.00';
                taxEl.textContent = '$0.00';
                totalEl.textContent = '$0.00';
                return;
            }

            let subtotal = 0;
            container.innerHTML = '';

            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                itemDiv.innerHTML = `
                    <div class="cart-item-info">
                        <h4>${item.name}</h4>
                        <p>$${item.price.toFixed(2)} each</p>
                    </div>
                    <div class="cart-item-quantity">
                        <button onclick="updateQuantity(${index}, -1)">-</button>
                        <span>${item.quantity}</span>
                        <button onclick="updateQuantity(${index}, 1)">+</button>
                    </div>
                    <div class="cart-item-total">
                        $${itemTotal.toFixed(2)}
                    </div>
                    <button class="cart-item-remove" onclick="removeItem(${index})">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                `;
                container.appendChild(itemDiv);
            });

            const tax = subtotal * 0.05;
            const total = subtotal + tax;

            subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
            taxEl.textContent = `$${tax.toFixed(2)}`;
            totalEl.textContent = `$${total.toFixed(2)}`;
        }

        function updateQuantity(index, change) {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (cart[index]) {
                cart[index].quantity += change;
                if (cart[index].quantity <= 0) {
                    cart.splice(index, 1);
                }
                localStorage.setItem('cart', JSON.stringify(cart));
                window.dispatchEvent(new Event('cartUpdated'));
                renderCart();
            }
        }

        function removeItem(index) {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            cart.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            window.dispatchEvent(new Event('cartUpdated'));
            renderCart();
        }

        // Initialize cart on page load
        document.addEventListener('DOMContentLoaded', () => {
            syncCartWithBackend();
        });
    </script>
</body>
</html>
